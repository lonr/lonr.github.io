---
tags: [React]
---

éœ€è¦å®ç° GitHub æ—¥å†é‡Œçš„ tooltipï¼Œå¸¸è§„çš„ Tooltip ç»„ä»¶æ˜¯åŒ…è£¹åœ¨å…¶ä»–ç»„ä»¶ä¸Šï¼Œæ¯”å¦‚ Primer æä¾›çš„ [Tooltip](https://primer.style/react/Tooltip)ï¼š

```jsx
<Tooltip aria-label="Hello, Tooltip!" direction="nw">
  <Button>Default</Button>
</Tooltip>
```

å’Œ Ant Design çš„ [Tooltip æ–‡å­—æç¤º](https://ant.design/components/tooltip-cn/#API)ï¼š

```jsx
<Tooltip title="prompt text">
  <span>Tooltip will show on mouse enter.</span>
</Tooltip>
```

è€Œæ—¥å†çš„æ—¥æœŸå¤ªå¤šï¼Œä¸å¯èƒ½ç»™æ¯å¤©ï¼ˆ`Rect` æ–¹å—ï¼‰éƒ½å¥—ä¸Šä¸€ä¸ª `Tooltip`ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ç°æˆçš„ Primer ç»„ä»¶

å‘ç°å…¶ä»–ä¸¤ä¸ªæ—¥å†å®ç°â€”â€”[kevinsqi/react-calendar-heatmap](https://github.com/kevinsqi/react-calendar-heatmap) å’Œ [grubersjoe/react-github-calendar](https://github.com/grubersjoe/react-github-calendar) ä¾èµ–çš„ [react-tooltip](https://github.com/wwayne/react-tooltip/blob/master/src/index.js) ä½¿ç”¨äº†â€œå…¨å±€â€çš„ Tooltipï¼Œæ­£é€‚åˆè¿™ä¸ªåœºæ™¯ã€‚

å› ä¸ºè¦å­¦ä¹  React APIï¼Œæ‰€ä»¥è‡ªå·±å†™äº†ä¸€ä¸ªï¼š

## GitHub çš„ Tooltip å®ç°

GitHub çš„æ—¥å† Tooltip ç›®å‰æ˜¯ vanilla js å®ç°çš„ã€‚åœ¨æ—¥å†æ€»çš„ `svg` æ ‡ç­¾ä¸Šç›‘å¬äº† [`mouseover`](https://developer.mozilla.org/en-US/docs/Web/API/Element/mouseover_event) å’Œ [`mouseout`](https://developer.mozilla.org/en-US/docs/Web/API/Element/mouseout_event) äº‹ä»¶ï¼Œç„¶åé€šè¿‡ `e.target` è·å¾— `rect` çš„ä½ç½®æ•°æ®æ˜¾ç¤º tooltip

<details><summary>æ‰“å¼€å¼€å‘è€…å·¥å…·å¯ä»¥æ‰¾åˆ°ç›¸å…³ä»£ç </summary>

```ts
observe('.js-calendar-graph-svg', function (el) {
  const container = el.closest<HTMLElement>('.js-calendar-graph')!
  container.addEventListener('mouseover', function (event: Event) {
    const target = event.target as Element
    if (target.matches('rect[data-count]')) {
      showTooltip(target)
    }
  })
  container.addEventListener('mouseout', hideTooltip)
  const fromStr = container.getAttribute('data-from')
  if (fromStr) {
    previousDay = utcDate(fromStr)
  }
})

function hideTooltip() {
  if (currentTooltip) {
    currentTooltip.hidden = true
  }
}

function showTooltip(el: Element) {
  hideTooltip()

  const date = utcDate(el.getAttribute('data-date')!)
  const count = parseInt(el.getAttribute('data-count') || '')

  const formatted = new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    timeZone: 'UTC'
  }).format(date)
  const label = count === 0 ? 'No' : new Intl.NumberFormat('en-US').format(count)

  const strong = document.createElement('strong')
  strong.textContent = `${label} ${count === 1 ? 'contribution' : 'contributions'}`

  currentTooltip.innerHTML = ''
  currentTooltip.append(strong, ` on ${formatted}`)

  // We have to show the tooltip before calculating it's position.
  currentTooltip.hidden = false

  const bounds = el.getBoundingClientRect()
  const x = bounds.left + window.pageXOffset - currentTooltip.offsetWidth / 2 + bounds.width / 2
  const y = bounds.bottom + window.pageYOffset - currentTooltip.offsetHeight - bounds.height * 2
  const graphContainer = document.querySelector('.js-calendar-graph')
  const graphContainerBounds = graphContainer!.getBoundingClientRect()
  currentTooltip.style.top = `${y}px`

  if (isTooFarLeft(graphContainerBounds, x)) {
    currentTooltip.style.left = `${southwestTooltip(bounds)}px`
    currentTooltip.classList.add('left')
    currentTooltip.classList.remove('right')
  } else if (isTooFarRight(graphContainerBounds, x)) {
    currentTooltip.style.left = `${southeastTooltip(bounds)}px`
    currentTooltip.classList.add('right')
    currentTooltip.classList.remove('left')
  } else {
    currentTooltip.style.left = `${x}px`
    currentTooltip.classList.remove('left')
    currentTooltip.classList.remove('right')
  }
}

function isTooFarLeft(graphContainerBounds: DOMRect, tooltipX: number) {
  return graphContainerBounds.x > tooltipX
}

function isTooFarRight(graphContainerBounds: DOMRect, tooltipX: number) {
  return graphContainerBounds.x + graphContainerBounds.width < tooltipX + currentTooltip.offsetWidth
}

function southwestTooltip(bounds: DOMRect) {
  return bounds.left + window.pageXOffset - currentTooltip.offsetWidth * 0.1 + bounds.width / 2
}

function southeastTooltip(bounds: DOMRect) {
  return bounds.left + window.pageXOffset - currentTooltip.offsetWidth * 0.9 + bounds.width / 2
```

</details>

## æˆ‘çš„ naive å®ç°

React ä½¿ç”¨åˆæˆäº‹ä»¶ï¼Œè€Œä¸”ä¼šè‡ªåŠ¨å§”æ‰˜ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æŠŠ listener åŠ åˆ°æ¯ä¸ª `<rect>` ä¸Šï¼ˆè¿˜æœ‰ä¸ªç±»ä¼¼ `mouseover` çš„äº‹ä»¶ï¼š [`mouseenter`](https://developer.mozilla.org/en-US/docs/Web/API/Element/mouseenter_event) äº‹ä»¶ï¼Œæœ¬èº«ä¸æ”¯æŒå†’æ³¡ï¼Œä½† React è®©å®ƒä¹Ÿèƒ½è¢«å§”æ‰˜ï¼ˆé€šè¿‡ `mouseover` äº‹ä»¶å®ç°ï¼‰ï¼‰

<details><summary>æˆ‘ç®€å•åœ°åœ¨ `<rect>` `onMouseEnter` æ—¶ä¿®æ”¹ Tooltip çš„ä½ç½®å’Œå†…å®¹ï¼Œç®€åŒ–çš„ä»£ç ï¼š</summary>

```js
import React, { useState } from 'react';

export default function App() {
  return (
    <div>
      <Calendar />
    </div>
  );
}

function Tooltip({ left, top, children }) {
  return (
    <div style={{ transform: 'translateY(-50%)', position: 'absolute', left, top }}>
      {'<'}
      {children}
    </div>
  );
}

function Calendar() {
  const [tooltip, setTooltip] = useState(null);

  function handleMouseEnter(e) {
    const bonds = e.target.getBoundingClientRect();
    setTooltip({
      left: bonds.right,
      top: bonds.top,
      text: e.target.dataset.tip,
    });
  }

  return (
    <div style={{ position: 'relative' }}>
      <span data-tip="tip1" onMouseEnter={handleMouseEnter}>
        1
      </span>
      <br />
      <span data-tip="tip2" onMouseEnter={handleMouseEnter}>
        2
      </span>
      {tooltip && (
        <Tooltip left={tooltip.left} top={tooltip.top}>
          {tooltip.text}
        </Tooltip>
      )}
    </div>
  );
}
```

</details>

é¼ æ ‡åœ¨æ—¥æœŸé—´å¿«é€Ÿæ»‘åŠ¨ï¼Œæ¸²æŸ“é€Ÿåº¦å’ŒåŸç”Ÿçš„æœ‰æ˜æ˜¾å·®è·ï¼Œbuild åçš„ç‰ˆæœ¬è²Œä¼¼å¥½ä¸€ç‚¹ä½†è¿˜æ˜¯å¾ˆæ˜æ˜¾

å‚è€ƒï¼š

- [Handling Events](https://reactjs.org/docs/handling-events.html)
- [Responding to Events](https://beta-reactjs-org-mtdw7s9u4-fbopensource.vercel.app/learn/responding-to-events)
- [What is the difference between the mouseover and mouseenter events?](https://stackoverflow.com/a/1104381/5783347)

## ä½¿ç”¨ React Profiler

çœ‹åˆ°å®˜æ–¹çš„æ–°æ–‡æ¡£é‡Œè¯´ï¼š

> Donâ€™t optimize prematurely!

è™½ç„¶åœ¨å…¶ä»–åœ°æ–¹åšäº†å¾ˆå¤šæ— ç”¨åŠŸï¼Œä½†è¿™ä¸ª tooltip ç¡®å®éœ€è¦ä¼˜åŒ–

ä½¿ç”¨ React Profiler å¯ä»¥çœ‹åˆ°ï¼š

![tooltip-profile-1](../assets/tooltip-profile-1.png)

çŒœæƒ³ï¼š

- Tooltip ä½¿ç”¨äº† styled-componentsï¼Œå¯èƒ½æ¯”è¾ƒå½±å“æ€§èƒ½
  - ä»æµè§ˆå™¨ Elements Inspector é‡Œä¹Ÿèƒ½çœ‹åˆ° `<style>` è¢«ä¸æ–­æ›´æ–°
  - Chrome è‡ªå¸¦çš„ Performance é‡Œå›¾æˆ‘çœ‹ä¸å¤ªæ‡‚ï¼Œä½†ä¹Ÿèƒ½çœ‹å‡º styled-components ç¡®å®å ç”¨äº†æ—¶é—´
- Calendar è¢« `setState` ä¸æ–­è§¦å‘ renderingï¼Œå³ä½¿ SVG æ—¥å†åœ¨ tooltip åˆ’è¿‡æ—¶å†…å®¹åº”è¯¥æ˜¯ä¸å˜çš„

æ‰€ä»¥æˆ‘å¯èƒ½éœ€è¦ï¼š

- åˆ†ç¦»æ—¥å†ä¸»ä½“éƒ¨åˆ†å¹¶ä½¿ç”¨ `useMemo` æ¥è·³è¿‡ diff æ£€æŸ¥ï¼ˆå®é™…ä¸Šï¼šåº”è¯¥ä½¿ç”¨ `React.memo`ï¼‰
- ä¼˜åŒ– Tooltip æ ·å¼ã€‚ç›®å‰æ„Ÿè§‰æ˜¯å› ä¸ºæˆ‘ä½¿ç”¨ `sx`ï¼ˆPrimer å°è£…çš„ Styled System APIï¼‰æ¥ä¿®æ”¹ Tooltip çš„æ ·å¼ï¼ˆå®é™…ä¸Šï¼šæ”¹ä¸º `style` å°±å¥½äº†ï¼‰

å…¶ä»–å®ç°ï¼š

- è§‚å¯Ÿäº†ä¸‹ [react-tooltip](https://github.com/wwayne/react-tooltip/blob/9006d11aa2/src/index.js) çš„å®ç°ï¼šæ‰‹åŠ¨ç›‘å¬äº‹ä»¶ä½†æ˜¯é€šè¿‡ React æ¥æ¸²æŸ“ tooltipã€‚å› ä¸ºåªæ¸²æŸ“ tooltip æ‰€ä»¥æ²¡æœ‰æ€§èƒ½é—®é¢˜ï¼Œæ‰‹åŠ¨ç›‘å¬å¤§æ¦‚æ˜¯ä¸ºäº†æ–¹ä¾¿
- React Profiler è‡ªå·±ä¹Ÿ[å®ç°äº†ä¸€ä¸ª tooltip](https://github.com/facebook/react/blob/main/packages/react-devtools-shared/src/devtools/views/Profiler/Tooltip.js)ï¼Œä¸è¿‡å¥½åƒæ€§èƒ½ä¹Ÿä¸å¤ªè¡Œ

å‚è€ƒï¼š

- [Optimizing Performance](https://reactjs.org/docs/optimizing-performance.html)
- [Introducing the React Profiler](https://reactjs.org/blog/2018/09/10/introducing-the-react-profiler.html)
- [Analyze runtime performance](https://developer.chrome.com/docs/devtools/evaluate-performance/)

## `React.memo`ã€`useMemo`ã€`useCallback`

> This process(_rendering_) is recursive: if the updated component returns some other component, React will render that component next, and if that component also returns something, it will render that component next, and so on. The process will continue until there are no more nested components and React knows exactly what should be displayed on screen. --from [_Step 2: React renders your components_](https://beta.reactjs.org/learn/render-and-commit#:~:text=This%20process%20is%20recursive%3A%20if%20the%20updated%20component%20returns%20some%20other%20component%2C%20React%20will%20render%20that%20component%20next%2C%20and%20if%20that%20component%20also%20returns%20something%2C%20it%20will%20render%20that%20component%20next%2C%20and%20so%20on.)

æ‰€ä»¥çˆ¶ç»„ä»¶çŠ¶æ€æ›´æ–°å­ç»„ä»¶ä¹Ÿä¼š rerenderï¼Œå³ä½¿å­ç»„ä»¶çš„çŠ¶æ€æ²¡å˜ã€‚å¯¹ç±»ç»„ä»¶å¯ä»¥ä½¿ç”¨ [`React.PureComponent`](https://reactjs.org/docs/react-api.html#reactpurecomponent) å’Œ [`shouldComponentUpdate`](https://reactjs.org/docs/react-component.html#shouldcomponentupdate) æ¥è·³è¿‡ï¼ˆä¿®æ”¹ï¼‰å­ç»„ä»¶çš„ rendering è¿‡ç¨‹ï¼›å¯¹å‡½æ•°ç»„ä»¶å¯ä»¥ä½¿ç”¨ [`React.memo`](https://reactjs.org/docs/react-api.html#reactmemo)ã€[`useMemo`ã€`useCallback`](https://reactjs.org/docs/hooks-reference.html#usecallback)

æ‰€ä»¥æˆ‘ï¼š

- æŠŠæ—¥å†æŠ½ç¦»å‡ºæ¥ä½œä¸ºä¸€ä¸ªç»„ä»¶ï¼Œå¹¶ä½¿ç”¨ `React.memo` è®©å®ƒåªåœ¨ props å˜åŒ–æ—¶åœ¨ rerender
- ä½¿ç”¨ `useCallback` ç¼“å­˜ä¼ å…¥æ—¥å†ç»„ä»¶çš„ handlers

è¿™æ · tooltip ç§»åŠ¨æ—¶æ—¥å†ç»„ä»¶ä¾¿ä¸å† rerender

![tooltip-profile-2](../assets/tooltip-profile-2.png)

---

`React.memo`

> React.memo only checks for prop changes. If your function component wrapped in React.memo has a useState, useReducer or useContext Hook in its implementation, it will still rerender when state or context change.

æ‰€ä»¥å¤§æ¦‚ï¼š

- context å…¨å±€æ›´æ”¹è§¦å‘ rerender
- prop çˆ¶ç»„ä»¶æ›´æ”¹è§¦å‘ rerenderã€‚`React.memo` å¯ä»¥å†³å®šæ˜¯å¦è¿›è¡Œ rerender
- state è‡ªèº«æ›´æ”¹è§¦å‘ rerender

å‚è€ƒï¼š

- [Render and Commit](https://beta.reactjs.org/learn/render-and-commit)
- [Reconciliation](https://reactjs.org/docs/reconciliation.html)
- [Use React.memo() wisely](https://dmitripavlutin.com/use-react-memo-wisely/)
- [How to Memoize with React.useMemo()](https://dmitripavlutin.com/react-usememo-hook/)
- [React Top-Level API](https://reactjs.org/docs/react-api.html#reactmemo)

## styled-components çš„é—®é¢˜

è‡³äº styled-components çš„é—®é¢˜ï¼Œå› ä¸ºå…¶å®ä¸éœ€è¦ `sx`ï¼Œæ‰€ä»¥ æˆ‘æŠŠ`sx` æ¢æˆ `style` å°±è§£å†³äº†ï¼Œè¿™æ · `<style>` ä¾¿ä¸å†åœ¨ tooltip ç§»åŠ¨æ—¶æ›´æ–°äº†

```diff
(<Tooltip
  direction="center"
  hidden={!!tooltip}
- sx={
+ style={
    tooltip
      ? { display: 'inline-block', left: tooltip.x, top: tooltip.y }
      : {}
  }
>)
```

![tooltip-profile-3](../assets/tooltip-profile-3.png)

æ­¤å¤–åœ¨ç§»åŠ¨æ—¶æ›´æ–°æ ·å¼è€Œä¸æ˜¯é”€æ¯åé‡æ–°ç”Ÿæˆï¼ˆæ•ˆä»¿äº† GitHub tooltipï¼‰

## `useRef`ã€`forwardRef`ã€`useLayoutEffect`ã€`flushSync`

è§£å†³äº†æ€§èƒ½é—®é¢˜ï¼Œç°åœ¨è§£å†³ä¸‹ tooltip åœ¨è¾¹ç¼˜æ—¶å¯èƒ½è¢«é®æŒ¡çš„é—®é¢˜ã€‚å› ä¸ºè¦åˆ¤æ–­é»˜è®¤æ ·å¼çš„ tooltip çš„è¾¹ç¼˜æ˜¯å¦è¶…è¿‡æ—¥å†çš„è¾¹ç¼˜ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ ref æ¥è·å¾—ä¸¤è€…çš„ä½ç½®ä¿¡æ¯

è·å¾— tooltip è‡ªå·±å®é™…çš„å°ºå¯¸åå†³å®šæ˜¯å¦ä¿®æ”¹æ ·å¼ï¼ˆğŸ”½ åœ¨å·¦è¾¹ã€ä¸­é—´è¿˜æ˜¯å³è¾¹ï¼‰ï¼Œå¦‚ä½•ä¿®æ”¹ `className` å‘¢ï¼Ÿ

- [ ] ä½¿ç”¨ `useLayoutEffect` + `ref`ï¼ˆå¦‚æœä½¿ç”¨ `useEffect` ç¡®å®ä¼šè§‚å¯Ÿåˆ°æŠ–åŠ¨ï¼‰
- [ ] ä½¿ç”¨ `useLayoutEffect` + `flushSync`ã€‚â€œè¯­ä¹‰â€ä¸Šæ˜¯å¯¹çš„è€Œä¸”çœ‹èµ·æ¥å·¥ä½œæ­£å¸¸ï¼Œä½†æ˜¯æŠ¥ warningï¼šflushSync was called from inside a lifecycle method. è²Œä¼¼ä¸åº”è¯¥è¿™æ ·ä½¿ç”¨ `flushSync`
- [x] åœ¨äº‹ä»¶ handler ä¸­ä½¿ç”¨ `flushSync` setStateï¼›è¯»å– ref å¹¶åˆ¤æ–­ï¼Œå¦‚æœè¶…è¿‡è¾¹ç¼˜åˆ™å†ä½¿ç”¨ä¸€ä¸ª `flushSync` setState è¿›è€Œä¿®æ”¹æ ·å¼

---

ä½¿ç”¨ `forwardRef` ç»‘å®š `ref` åˆ°ç»„ä»¶çš„çœŸå®çš„å…ƒç´ ä¸Š

å‚è€ƒï¼š

- [Have you used `flushSync` in React?](https://dev.to/somshekhar/have-you-used-flushsync-in-react-4cpo)

## æ€»ç»“

- æ¯”æƒ³è±¡çš„é¡ºåˆ©ï¼šæœ¬ä»¥ä¸ºè¦ä½¿ç”¨ `useRef` ä½¿ç”¨åŸç”Ÿçš„ JSï¼Œç»“æœ React æœ¬èº«çš„æ•ˆç‡å°±è¶³å¤Ÿäº†
- æœ€ç»ˆé€‰æ‹©äº†æ­£ç¡®çš„ APIï¼šä½¿ç”¨ `React.memo` è€Œä¸æ˜¯ `useMemo`
- æ‰€ä»¥ï¼Œå¦‚æœä½¿ç”¨å…¶ä»–æ¡†æ¶æ˜¯ä¸éœ€è¦åšè¿™äº›â€œä¼˜åŒ–â€çš„ï¼Ÿ
